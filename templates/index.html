<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="/static/bop.png" type="image/png" />
  <title>Bop Central</title>

  <!-- Open Graph / Facebook Embed -->
  <meta property="og:title" content="Bop Central – TikTok Viewer" />
  <meta property="og:description" content="Watch TikTok Bops or randoms. Search users, browse latest or top videos, and download your favorites." />
  <meta property="og:image" content="https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png" />
  <meta property="og:url" content="https://bopcentral.onrender.com/" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Bop Central – TikTok Viewer" />
  <meta name="twitter:description" content="Watch TikTok videos. Search users, browse latest or top videos, and download your favorites." />
  <meta name="twitter:image" content="hhttps://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png" />

  <!-- Prevent indexing -->
  <meta name="robots" content="noindex,nofollow" />

  <!-- JSZip for zipping multiple images to a single ZIP (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-4gM9G56u5Xb0u1tLQ6z0k7Jz6V1Xq0f3v2w3HUCmYh5s9f2aOqzJ1xC3u2mL3Q8r5v2O3QbqkP4n5YlK7Yb2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* disable selection and copying */
    * {
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
    }
    /* reset & base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      overflow-x: hidden;
    }

    /* Loader Screen */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 9999;
    }
    #loader .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255, 255, 255, 0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Auth container */
    #auth-container {
      display: none;
      height: 100vh;
      width: 100%;
      background: #000;
      color: #fff;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #auth-container img {
      width: 150px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 10px #8e2de2);
      animation: glowPulse 2s ease-in-out infinite;
    }
    @keyframes glowPulse {
      0%, 100% { filter: drop-shadow(0 0 10px #8e2de2); }
      50%       { filter: drop-shadow(0 0 30px #4a00e0); }
    }
    .tabs { display: flex; margin-bottom: 20px; }
    .tabs button {
      flex: 1; padding: 10px; background: #151515; border: none;
      cursor: pointer; color: #fff; font-weight: bold;
    }
    .tabs button.active { background: #333; }
    .form-container { width: 300px; }
    .form-container form {
      display: none; flex-direction: column; gap: 12px;
    }
    .form-container form.active { display: flex; }
    .form-container input {
      padding: 8px; border-radius: 4px; border: none;
    }
    .form-container button {
      padding: 10px; border: none; border-radius: 4px;
      cursor: pointer; background: #4a00e0; color: #fff;
    }
    .form-error { color: #ff004f; font-size: 0.9rem; }

    /* Main app container */
    #app-content {
      display: none;
      position: relative;
      padding-top: 12rem;
    }

    /* Header & Navigation */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      z-index: 1000;
    }
    /* LOGO STAYS IN PLACE WHEN SCROLLING */
    header .logo-container {
      position: fixed;
      left: 20px;
      top: 1rem;
      z-index: 1001;
    }
    header img.logo {
      height: 10rem;
    }
    nav {
      display: flex;
      gap: 20px;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: bold;
    }
    nav a.active,
    nav a:hover {
      background: #333;
      color: #ff004f;
    }

    /* Sidebar toggle button */
    #sidebar-toggle {
      position: absolute;
      right: 20px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* About Us sidebar */
    .about-us {
      position: fixed;
      top: 12rem;
      right: -300px;
      width: 260px;
      background: #111;
      padding: 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      line-height: 1.4;
      transition: right 0.3s ease;
      z-index: 999;
    }
    .about-us.open {
      right: 20px;
    }
    .about-us h2 {
      margin-bottom: 10px;
      font-size: 1.2rem;
      color: #4a00e0;
    }

    /* Page wrappers */
    #page-home,
    #page-urls,
    #page-users,
    #page-videos,
    #page-saved-user,
    #page-slideshow {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }

    /* Hero */
    .hero {
      border: 2px solid;
      border-image: linear-gradient(90deg, #8e2de2, #00ff6a) 1;
      padding: 2rem;
      margin-bottom: 20px;
      border-radius: 8px;
      text-align: center;
    }

    /* Shared search bar style */
    .search-bar {
      width: 100%;
      display: flex;
      margin-bottom: 20px;
    }
    .search-bar input {
      flex: 1;
      padding: 12px;
      border-radius: 4px 0 0 4px;
      border: none;
    }
    .search-bar button {
      padding: 12px 20px;
      border: none;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
      background: #151515;
      color: #fff;
    }
    .search-bar button:hover {
      background: #333;
    }

    /* Video & URL grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: #151515;
      padding: 16px;
      border-radius: 6px;
      text-align: center;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .card img,
    .card video {
      width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .card audio {
      width: 100%;
      margin-bottom: 10px;
    }
    .card .title {
      font-size: 1rem;
      margin-top: 6px;
    }
    .card .views {
      font-size: 0.85rem;
      margin-top: 4px;
      color: #aaa;
    }
    /* ensure buttons stand out */
    .card-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .card-buttons a button,
    .card-buttons button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #4a00e0;
      color: #fff;
      font-size: 0.9rem;
    }
    .card-buttons a button:hover,
    .card-buttons button:hover {
      background: #00ff6a;
      color: #000;
    }
    .card-buttons button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Video placeholder (lazy-load video) */
    .video-placeholder {
      position: relative;
      cursor: pointer;
      overflow: hidden;
      border-radius: 6px;
    }
    .video-placeholder img.thumb {
      width: 100%;
      display: block;
      border-radius: 6px;
    }
    .video-placeholder .btn-play {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.6);
      border: none;
      color: #fff;
      font-size: 2rem;
      padding: 12px 18px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 0 12px rgba(255,0,80,0.4);
    }

    /* Slideshow Modal */
    #image-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      z-index: 10000;
      flex-direction: column;
    }
    #image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 4px;
    }
    #image-modal .prev,
    #image-modal .next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 3rem;
      color: #fff;
      cursor: pointer;
      user-select: none;
      padding: 0 20px;
      text-shadow: 0 0 8px #ff004f;
    }
    #image-modal .prev { left: 10px; }
    #image-modal .next { right: 10px; }
    #image-modal .close,
    #modal-download,
    #modal-download-all {
      position: absolute;
      top: 20px;
      font-size: 2rem;
      color: #fff;
      cursor: pointer;
      user-select: none;
      text-shadow: 0 0 8px #ff004f;
      background: none;
      border: none;
    }
    #image-modal .close { right: 30px; }
    #modal-download {
      right: 120px;
    }
    #modal-download-all {
      right: 180px;
    }
    #modal-download:hover,
    #modal-download-all:hover {
      color: #ff004f;
    }

    /* Delete buttons */
    .delete-user,
    .delete-url {
      display: none;
      margin-top: 8px;
      background: #ff4d4f;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-size: 0.8rem;
    }

    /* Users grid */
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .user-entry {
      position: relative;
      text-align: center;
    }
    .user-card {
      background: #151515;
      padding: 12px;
      border-radius: 6px;
      transition: transform 0.2s;
      cursor: pointer;
    }
    .user-card:hover {
      transform: scale(1.05);
    }
    .user-card img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 8px;
    }
    .handle {
      display: block;
      font-weight: bold;
      font-size: 0.85rem;
      hyphens: auto;
    }
    .videos-container {
      display: none;
      margin-top: 16px;
    }
    .videos-container.grid {
      display: grid;
    }

    /* Admin Password Modal */
    #admin-pass-modal {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    #admin-pass-modal .modal-content {
      background: #111;
      padding: 2rem;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
    }
    #admin-pass-modal h2 {
      margin-bottom: 1rem;
      color: #8e2de2;
      font-size: 1.5rem;
    }
    #admin-pass-modal input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      border: none; border-radius: 4px;
      font-size: 1rem;
    }
    #admin-pass-modal .error {
      color: #ff004f; margin-bottom: 0.75rem;
      height: 1rem;
    }
    #admin-pass-modal .buttons {
      display: flex; gap: 0.5rem; justify-content: center;
    }
    #admin-pass-modal .buttons button {
      flex: 1; padding: 0.75rem; border: none;
      border-radius: 4px; cursor: pointer;
      font-size: 1rem;
    }
    #admin-pass-modal .buttons .submit { background: #4a00e0; color: #fff; }
    #admin-pass-modal .buttons .cancel { background: #333; color: #fff; }

    /* CUSTOM CONTEXT MENU */
    #custom-menu {
      position: fixed; display: none; background: #222;
      border: 1px solid #555; border-radius: 4px;
      z-index: 3000; padding: 8px 0; font-size: 0.9rem;
      color: #fff;
      box-shadow: 0 0 10px #ff004f;
    }
    #custom-menu li {
      list-style: none; padding: 6px 20px; cursor: pointer;
      transition: all 0.2s;
    }
    #custom-menu li:hover {
      background: #333;
      text-shadow: 0 0 5px #ff004f;
    }
    #custom-menu li.glow {
      color: #ff004f;
      text-shadow: 0 0 8px #ff004f;
    }

    /* small helper for the toggle */
    .videos-controls {
      display:flex;
      justify-content:center;
      gap:8px;
      margin-bottom:12px;
      align-items:center;
    }
    .videos-controls button {
      padding:8px 12px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      background:#222;
      color:#fff;
    }
    .videos-controls button.active {
      background:#4a00e0;
      color:#fff;
    }

    /* hide images-only control when not applicable */
    .videos-controls.hidden { display: none; }

    /* small spinner inside HD button */
    .hd-spinner {
      display:inline-block;
      width:14px;height:14px;border:2px solid rgba(255,255,255,0.2);
      border-top-color:#fff;border-radius:50%;vertical-align:middle;margin-left:8px;
      animation:spin 0.8s linear infinite;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader">
    <div class="spinner"></div>
    <img id="loader-image" src="https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png" alt="Loading…" />
  </div>

  <!-- Auth UI -->
  <div id="auth-container">
    <img src="https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png" alt="Logo" />
    <div class="tabs">
      <button id="tab-login" class="active">Login</button>
      <button id="tab-register">Register</button>
    </div>
    <div class="form-container">
      <form id="form-login" class="active">
        <input type="text" id="login-username" placeholder="Username" required />
        <input type="password" id="login-password" placeholder="Password" required />
        <button type="submit">Login</button>
        <div class="form-error" id="error-login"></div>
      </form>
      <form id="form-register">
        <input type="text" id="reg-username" placeholder="Username" required />
        <input type="password" id="reg-password" placeholder="Password" required />
        <input type="text" id="reg-invite" placeholder="Invite Code" required />
        <button type="submit">Register</button>
        <div class="form-error" id="error-register"></div>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="app-content">
    <header>
      <a href="/" class="logo-container">
        <img src="https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png" alt="Bop Central Logo" class="logo" />
      </a>
      <nav>
        <a href="/" data-view="home">Home</a>
        <a href="/?type=latest" data-view="latest">Latest</a>
        <a href="/?type=top" data-view="top">Top</a>
        <a href="/?view=urls" data-view="urls">Saved URLs</a>
        <a href="/?view=users" data-view="users">Saved Users</a>
        <a href="/?view=slideshow" data-view="slideshow">Slideshows</a>
      </nav>
      <button id="sidebar-toggle">☰</button>
    </header>

    <!-- Custom Context Menu -->
    <ul id="custom-menu">
      <li id="menu-save">Save video as…</li>
      <li id="menu-open">Open video in new tab</li>
      <li id="menu-download-image">Download image</li>
    </ul>

    <!-- About sidebar -->
    <aside class="about-us">
      <h2>About Bop Central</h2>
      <p>
        Bop Central is your go-to TikTok downloader and viewer. Dive into the latest and greatest TikTok “bops” and explore what others
        are sharing. Whether you want to search by username, browse the top trending videos, or fetch and download content via URL,
        Bop Central makes it easy and seamless. Keep up with your favorite creators, discover new interests, and save videos for offline
        viewing—all in one place.
      </p>
    </aside>

    <!-- HOME PAGE -->
    <div id="page-home">
      <section class="hero">
        <h2>Bop Central – Watch & Download TikTok Videos</h2>
        <p>Search users, browse latest or top videos, or fetch by URL.</p>
      </section>
      <form class="search-bar" method="get" action="/">
        <input name="q" type="text" placeholder="Input username…" value="{{ active_q }}" />
        <button type="submit">Go</button>
      </form>
    </div>

    <!-- URLS PAGE -->
    <div id="page-urls" style="display:none;">
      <form class="search-bar" id="url-form">
        <input type="url" id="url-input" placeholder="Enter TikTok video URL…" required />
        <button type="submit">Fetch Video</button>
      </form>
      <section id="url-section" style="display:none;">
        <h3 style="text-align:center;">Result</h3>
        <div class="grid" id="url-grid"></div>
      </section>
    </div>

    <!-- USERS PAGE -->
    <div id="page-users" style="display:none;">
      <form class="search-bar" id="user-search-form">
        <input type="text" id="user-search" placeholder="Search saved users…" />
        <button type="button">Go</button>
      </form>
      <div class="users-grid"></div>
    </div>

    <!-- SAVED USER PAGE -->
    <div id="page-saved-user" style="display:none;">
      <section>
        <h3 style="text-align:center;" id="saved-user-title">Videos & Slideshows for </h3>
        <div class="grid" id="saved-user-grid"></div>
      </section>
    </div>

    <!-- VIDEOS PAGE -->
    <div id="page-videos" style="display:none;">
      <section id="videos-section">
        <h3 style="text-align:center;">
          {% if active_q %} Results for "{{ active_q }}"
          {% elif view_type == 'latest' %} Latest Videos
          {% elif view_type == 'top' %} Top Videos
          {% endif %}
        </h3>

        <div id="videos-controls" class="videos-controls" style="margin-bottom:12px;">
          <button id="btn-images-only" class="active" title="Show only image/story posts on load">Stories (images)</button>
          <button id="btn-show-all" title="Show videos too (lazy-loaded)">Show videos</button>
          <div style="flex:1"></div>
          <button id="btn-refresh" title="Refresh saved urls">Refresh</button>
        </div>

        <div class="grid" id="videos-grid">
          {% for v in user_videos %}
            <div class="card" data-aweme="{{ v.aweme_id }}" data-hd="{{ hd_urls.get(v.aweme_id,'') }}">
              {% if v.images and v.images|length > 0 and (view_type not in ['latest','top']) %}
                <img
                  src="{{ v.images[0] }}"
                  class="single-img"
                  data-aweme-id="{{ v.aweme_id }}"
                  data-index="0"
                  data-images='{{ v.images|tojson }}'
                />
                {% if v.play_url %}
                  <audio controls src="{{ v.play_url }}"></audio>
                {% endif %}
              {% else %}
                <div class="video-placeholder"
                     data-aweme-id="{{ v.aweme_id }}"
                     data-play-url="{{ v.play_url }}"
                     data-cover="{{ v.cover or '' }}">
                  <img src="{{ v.cover or 'https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png' }}" class="thumb" alt="thumb"/>
                  <button class="btn-play" title="Load video">▶</button>
                </div>
              {% endif %}
              <div class="title">{{ v.text or ("Video " ~ v.aweme_id) }}</div>
              <div class="views" id="views-{{ v.aweme_id }}">{{ v.play_count }} views</div>
              <div class="card-buttons">
                <a href="/download?video_id={{ v.aweme_id }}&hd=0" download><button>Download</button></a>
                <!-- keep HD for video cards only; slideshow/image cards below won't show HD -->
                {% if not (v.images and v.images|length > 0) %}
                  <button class="hd-trigger" data-aweme="{{ v.aweme_id }}">HD</button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    </div>

    <!-- SLIDESHOW PAGE -->
    <div id="page-slideshow" style="display:none;">
      <section>
        <h3 style="text-align:center;">
          Slideshows{% if active_q %} for "{{ active_q }}"{% endif %}
        </h3>
        <form class="search-bar" id="slideshow-search-form">
          <input
            type="text"
            id="slideshow-search"
            placeholder="Enter username(s), comma-separated..."
            value="{{ active_q }}"
          />
          <button type="button">Filter</button>
        </form>
        <div class="grid" id="slideshow-grid"></div>
      </section>
    </div>
  </div>

  <!-- Image Slideshow Modal -->
  <div id="image-modal">
    <span class="close" title="Close">&times;</span>
    <span class="prev" title="Previous">&#10094;</span>
    <img src="" />
    <button id="modal-download" title="Download this image">⬇</button>
    <button id="modal-download-all" title="Download all images in slideshow">⬇⬇ All</button>
    <span class="next" title="Next">&#10095;</span>
  </div>

  <!-- Admin Password Modal -->
  <div id="admin-pass-modal">
    <div class="modal-content">
      <h2>Admin Access</h2>
      <input type="password" id="admin-pass-input" placeholder="Enter password…" />
      <div class="error" id="admin-pass-error"></div>
      <div class="buttons">
        <button class="submit" id="admin-pass-submit">Unlock</button>
        <button class="cancel" id="admin-pass-cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // expose server-rendered view_type to JS
    const VIEW_TYPE = "{{ view_type or '' }}";

    // Sidebar toggle & anti-copy
    document.getElementById('sidebar-toggle').onclick = () =>
      document.querySelector('.about-us').classList.toggle('open');
    ['contextmenu','copy','cut'].forEach(e =>
      document.addEventListener(e, ev => ev.preventDefault())
    );

    // Anti-CTRL+U
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key.toLowerCase() === 'u') {
        e.preventDefault();
        alert('Custom Error: Viewing source is disabled on this site.');
      }
    });

    // filter saved users by search
    document.getElementById('user-search-form').onsubmit = e => {
      e.preventDefault();
      const q = document.getElementById('user-search').value.toLowerCase();
      document.querySelectorAll('.user-entry').forEach(ent => {
        const name = ent.querySelector('.handle').textContent.toLowerCase();
        ent.style.display = name.includes(q) ? '' : 'none';
      });
    };

    // Auth handling (login/register)
    function initAuth() {
      document.getElementById('tab-login').onclick = () => {
        document.getElementById('form-login').classList.add('active');
        document.getElementById('form-register').classList.remove('active');
        document.getElementById('tab-login').classList.add('active');
        document.getElementById('tab-register').classList.remove('active');
      };
      document.getElementById('tab-register').onclick = () => {
        document.getElementById("form-register").classList.add('active');
        document.getElementById("form-login").classList.remove('active');
        document.getElementById("tab-register").classList.add('active');
        document.getElementById("tab-login").classList.remove('active');
      };

      document.getElementById('form-login').onsubmit = async e => {
        e.preventDefault();
        const u = document.getElementById('login-username').value.trim();
        const p = document.getElementById('login-password').value;
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({username:u,password:p})
        });
        if (!res.ok) {
          document.getElementById('error-login').textContent = await res.text() || 'Login failed';
          return;
        }
        const d = await res.json();
        localStorage.setItem('tikify_token', d.access_token);
        location.reload();
      };

      document.getElementById('form-register').onsubmit = async e => {
        e.preventDefault();
        const u = document.getElementById('reg-username').value.trim();
        const p = document.getElementById('reg-password').value;
        const i = document.getElementById('reg-invite').value.trim();
        const res = await fetch('/api/register',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({username:u,password:p,invite_code:i})
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({}));
          document.getElementById('error-register').textContent = err.detail || 'Registration failed';
          return;
        }
        document.getElementById('tab-login').click();
        document.getElementById('error-login').textContent = 'Registered! Please log in.';
      };
    }

    // Admin-mode modal
    let adminMode = false;
    const pw = [98,111,112,112].map(c=>String.fromCharCode(c)).join('');
    const modal = document.getElementById('admin-pass-modal'),
          inp   = document.getElementById('admin-pass-input'),
          errEl = document.getElementById('admin-pass-error');
    document.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key==='\\') {
        if (!adminMode && modal.style.display!=='flex') {
          inp.value = ''; errEl.textContent = '';
          modal.style.display = 'flex';
          setTimeout(()=>inp.focus(),100);
        } else {
          adminMode = false;
          document.querySelectorAll('.delete-user,.delete-url')
                  .forEach(b=>b.style.display='none');
        }
      }
      if (e.key==='Escape') modal.style.display='none';
    });
    document.getElementById('admin-pass-submit').onclick = () => {
      if (inp.value===pw){
        adminMode=true;
        modal.style.display='none';
        document.querySelectorAll('.delete-user,.delete-url')
                .forEach(b=>b.style.display='block');
      } else errEl.textContent='Wrong password';
    };
    document.getElementById('admin-pass-cancel').onclick = () => modal.style.display='none';

    // delete-user & delete-url
    function bindDeleteUsers(){
      document.querySelectorAll('.delete-user').forEach(b=>{
        b.onclick = async ()=> {
          if (!confirm(`Delete user ${b.dataset.username}?`)) return;
          const r = await fetch(`/api/saved-users/${encodeURIComponent(b.dataset.username)}`,{method:'DELETE'});
          if (r.ok) b.closest('.user-entry').remove();
          else alert('Failed to delete user');
        };
      });
    }
    function bindDeleteUrls(){
      document.querySelectorAll('.delete-url').forEach(b=>{
        b.onclick = async ()=> {
          if (!confirm(`Delete saved URL ${b.dataset.aweme}?`)) return;
          const r = await fetch(`/api/saved-urls/${encodeURIComponent(b.dataset.aweme)}`,{method:'DELETE'});
          if (r.ok) b.closest('.card').remove();
          else alert('Failed to delete URL');
        };
      });
    }

    // helper to download a remote URL as a file using fetch -> blob
    async function downloadUrlAsFile(url, suggestedName) {
      try {
        const res = await fetch(url, {mode: 'cors'});
        if (!res.ok) throw new Error('Network response not ok: ' + res.status);
        const blob = await res.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = suggestedName || '';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        return true;
      } catch (err) {
        console.debug('downloadUrlAsFile failed for', url, err);
        return false;
      }
    }

    // fallback simple downloader (may open in new tab if cross-origin prevents download)
    function fallbackDirectDownload(url, suggestedName) {
      try {
        const a = document.createElement('a');
        a.href = url;
        if (suggestedName) a.download = suggestedName;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (e) {
        console.debug('fallbackDirectDownload failed', e);
        window.open(url, '_blank');
      }
    }

    // URL form handler
    document.getElementById('url-form').onsubmit = async e =>{
      e.preventDefault();
      const url = document.getElementById('url-input').value.trim();
      try {
        const res = await fetch('/api/from-url',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
        if (!res.ok) { alert((await res.json()).detail||'Failed to resolve URL'); return; }
        const data = await res.json();
        await fetch('/api/saved-urls',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        fetchSavedUrls();
      } catch {
        alert('Error fetching video');
      }
    };

    // Home search form: disallow URLs
    document.querySelector('#page-home .search-bar').onsubmit = function(e) {
      const q = this.querySelector('input[name="q"]').value.trim();
      if (/https?:\/\//i.test(q) || q.includes('www.')) {
        e.preventDefault();
        alert('Please input username not url');
      }
    };

    // saveFetchedUserUrls (BATCHED): collects all visible cards for the current query and posts a single array
    async function saveFetchedUserUrls() {
      const params = new URLSearchParams(location.search);
      const q = params.get('q');
      if (!q) return;

      // fetch existing saved user urls to avoid duplicates
      let existing = [];
      try {
        const er = await fetch('/api/saved-user-urls');
        if (er.ok) existing = await er.json();
      } catch (e) {
        console.debug('Failed to fetch existing saved-user-urls', e);
      }
      const existingSet = new Set(existing.map(e => `${(e.username||'').toLowerCase()}|||${e.aweme_id}`));

      const entries = [];
      // iterate each card in videos-grid
      document.querySelectorAll('#videos-grid .card').forEach(card => {
        try {
          const imgEl = card.querySelector('.single-img');
          const placeholder = card.querySelector('.video-placeholder');
          const aweme = card.dataset.aweme || (imgEl && (imgEl.dataset.awemeId||imgEl.dataset.awemeId)) || (placeholder && placeholder.dataset.awemeId);
          if (!aweme) return;

          const key = `${q.toLowerCase()}|||${aweme}`;
          if (existingSet.has(key)) {
            // skip already-saved entry
            return;
          }

          let play_url = '';
          let hd_url = card.dataset.hd || '';
          let images = [];

          if (imgEl) {
            images = JSON.parse(imgEl.dataset.images || '[]');
            const audio = card.querySelector('audio');
            play_url = audio ? audio.src : (images.length ? images[0] : '');
          } else if (placeholder) {
            play_url = placeholder.dataset.playUrl || '';
            images = [];
          } else {
            const vid = card.querySelector('video');
            if (vid) {
              const src = vid.querySelector('source') ? vid.querySelector('source').src : vid.src;
              play_url = src || '';
            }
          }

          entries.push({
            username: q,
            aweme_id: aweme,
            play_url: play_url,
            hd_url: hd_url,
            images: images
          });
        } catch (err) {
          console.debug('saveFetchedUserUrls skipped a card', err);
        }
      });

      if (!entries.length) return;

      try {
        // POST the array of entries in one request (server supports list payload)
        const r = await fetch('/api/saved-user-urls', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(entries)
        });
        if (!r.ok) {
          console.debug('Failed to save saved-user-urls batch', await r.text());
        } else {
          console.debug('Saved', entries.length, 'entries to saved-user-urls');
        }
      } catch (e) {
        console.debug('Error posting saved-user-urls batch', e);
      }
    }

    // NAV & VIEW SWITCHING
    function highlightNav(){
      const p    = new URLSearchParams(location.search),
            hasQ = !!p.get('q'),
            view = p.get('view')||p.get('type')||(hasQ?'videos':'home');
      document.querySelectorAll('nav a').forEach(a=>
        a.classList.toggle('active', a.dataset.view===view)
      );
      ['home','urls','users','videos','saved-user','slideshow'].forEach(v=>{
        const el = document.getElementById('page-'+v);
        if (!el) return;
        el.style.display =
          (v===view||(['latest','top'].includes(view)&&v==='videos'))?'block':'none';
      });
      if(view==='users'){
        fetchSavedUsers();
      }
      if(view==='slideshow'){
        fetchSlides();
      }
    }

    // Fetch & render saved URLs — show ONLY URLs that were inputted manually (no username/user)
    async function fetchSavedUrls(){
      try {
        const res = await fetch('/api/saved-urls');
        const savedRaw = (res.ok) ? await res.json() : [];
        // Keep only items that don't have a username/user (i.e. manual URL inputs)
        const saved = Array.isArray(savedRaw)
          ? savedRaw.filter(v => {
              // treat empty-string or null as "no username"
              const uname = v && (v.username || v.user);
              return !(typeof uname === 'string' ? uname.trim().length > 0 : !!uname);
            })
          : [];
        const filteredOutCount = Array.isArray(savedRaw) ? (savedRaw.length - saved.length) : 0;
        renderUrlSection(saved, filteredOutCount);
      } catch (err) {
        console.debug('fetchSavedUrls error', err);
        renderUrlSection([], 0);
      }
    }

    function renderUrlSection(savedUrls, filteredOutCount = 0){
      const sec = document.getElementById('url-section'),
            g   = document.getElementById('url-grid');

      if (!Array.isArray(savedUrls) || !savedUrls.length){
        sec.style.display='none';
        return;
      }

      sec.style.display='block';
      g.innerHTML='';

      // optional small info banner about filtered entries
      let info = document.getElementById('url-filter-info');
      if (!info) {
        info = document.createElement('div');
        info.id = 'url-filter-info';
        info.style.textAlign = 'center';
        info.style.color = '#aaa';
        info.style.margin = '8px 0 12px 0';
        sec.insertBefore(info, g);
      }
      if (filteredOutCount > 0) {
        info.textContent = `${filteredOutCount} item(s) filtered out (these came from saved users). Showing only manually-entered URLs.`;
      } else {
        info.textContent = '';
      }

      savedUrls.forEach(v=>{
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML=`
          <video controls data-aweme-id="${v.aweme_id}">
            <source src="${v.play_url}" type="video/mp4">
          </video>
          <div class="title">Video ${v.aweme_id}</div>
          <div class="views" id="views-${v.aweme_id}">
            ${v.play_count||0} views
          </div>
          <div class="card-buttons">
            <a href="/download?video_id=${v.aweme_id}&hd=0" download><button>Download</button></a>
          </div>
          <button class="delete-url" data-aweme="${v.aweme_id}">
            Delete
          </button>`;
        g.appendChild(card);
      });

      bindDeleteUrls();
    }

    // Fetch & render saved users
    async function fetchSavedUsers(){
      const [resUsers, resUrls] = await Promise.allSettled([
        fetch('/api/saved-users'),
        fetch('/api/saved-user-urls')
      ]);
      if (resUsers.status !== 'fulfilled' || !resUsers.value.ok) return;
      const users = await resUsers.value.json();
      let urls = [];
      if (resUrls.status === 'fulfilled' && resUrls.value.ok) {
        urls = await resUrls.value.json();
      } else {
        try {
          const r = await fetch('/api/saved-urls');
          if (r.ok) {
            const savedUrls = await r.json();
            urls = savedUrls.map(s => ({ username: s.username || '', aweme_id: s.aweme_id, images: s.images || [], play_url: s.play_url }));
          }
        } catch(e){}
      }

      const urlUsernames = new Set(urls.map(u => u.username));
      const seen = new Set();
      const filtered = users
        .filter(u => urlUsernames.has(u.username))
        .filter(u => {
          if (seen.has(u.username)) return false;
          seen.add(u.username);
          return true;
        });
      renderUserSection(filtered);
    }
    function renderUserSection(users){
      const grid = document.querySelector('.users-grid');
      grid.innerHTML='';
      users.forEach(u=>{
        const entry = document.createElement('div');
        entry.className='user-entry';

        const link = document.createElement('div');
        link.className='user-card';
        link.innerHTML = `
          <img src="${u.avatar || 'https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png'}" alt="${u.username}"/>
          <span class="handle">${u.username}</span>`;
        entry.appendChild(link);

        const vids = document.createElement('div');
        vids.className='videos-container';
        entry.appendChild(vids);

        const del = document.createElement('button');
        del.className='delete-user';
        del.dataset.username = u.username;
        del.textContent = 'Delete';
        entry.appendChild(del);

        link.onclick = () => showSavedUser(u.username);

        grid.appendChild(entry);
      });
      bindDeleteUsers();
    }

    // SHOW SAVED USER PAGE (with image download buttons, no HD buttons for images)
    async function showSavedUser(username){
      document.getElementById('saved-user-title').textContent = `Videos & Slideshows for ${username}`;
      const grid = document.getElementById('saved-user-grid');
      grid.innerHTML = '';
      const resp     = await fetch('/api/saved-user-urls'),
            all      = resp.ok ? await resp.json() : [];
      const userUrls = all.filter(item=>item.username===username);

      if (userUrls.length){
        userUrls.forEach(v=>{
          const c = document.createElement('div');
          c.className='card';

          if (v.images && v.images.length){
            // slideshow card - NO HD button
            const thumb = document.createElement('img');
            thumb.src = v.images[0];
            thumb.className = 'single-img';
            thumb.dataset.images = JSON.stringify(v.images || []);
            thumb.dataset.awemeId = v.aweme_id || '';
            thumb.dataset.username = username || '';
            c.appendChild(thumb);
            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = v.aweme_id || '';
            c.appendChild(title);

            const btns = document.createElement('div');
            btns.className = 'card-buttons';

            // single-image download (first image)
            const dlAnchor = document.createElement('a');
            dlAnchor.href = v.images[0];
            dlAnchor.setAttribute('download', '');
            const dlBtn = document.createElement('button');
            dlBtn.textContent = 'Download';
            dlAnchor.appendChild(dlBtn);
            btns.appendChild(dlAnchor);

            // Download All images button (card-level)
            const dlAllBtn = document.createElement('button');
            dlAllBtn.textContent = 'Download All';
            dlAllBtn.onclick = async () => {
              // attempt zip
              const imgs = JSON.parse(thumb.dataset.images || '[]');
              if (!imgs.length) { alert('No images to download'); return; }
              await downloadAllImagesAsZip(imgs, `${username || 'slideshow'}_${v.aweme_id || Date.now()}`);
            };
            btns.appendChild(dlAllBtn);

            c.appendChild(btns);
          } else {
            // plain video
            const vidHtml = document.createElement('div');
            vidHtml.innerHTML = `
              <video controls data-aweme-id="${v.aweme_id}">
                <source src="${v.play_url}" type="video/mp4">
              </video>
              <div class="title">${v.aweme_id}</div>
            `;
            c.appendChild(vidHtml);

            const btns = document.createElement('div');
            btns.className = 'card-buttons';
            const a = document.createElement('a');
            a.href = `/download?video_id=${v.aweme_id}&hd=0`;
            a.setAttribute('download', '');
            const btn = document.createElement('button');
            btn.textContent = 'Download';
            a.appendChild(btn);
            btns.appendChild(a);

            // HD still available for videos
            const hd = document.createElement('button');
            hd.className = 'hd-trigger';
            hd.dataset.aweme = v.aweme_id;
            hd.textContent = 'HD';
            btns.appendChild(hd);

            c.appendChild(btns);
          }

          grid.appendChild(c);
        });
      } else {
        grid.innerHTML = '<p style="color:#aaa;text-align:center;">No saved content for this user.</p>';
      }

      document.querySelectorAll('#app-content > div[id^="page-"]').forEach(d=>d.style.display='none');
      document.getElementById('page-saved-user').style.display = 'block';
      window.dispatchEvent(new Event('slideshowRendered'));
    }

    // increment views on audio/video play
    document.body.addEventListener('play', async e=>{
      if ((e.target.tagName==='VIDEO'||e.target.tagName==='AUDIO') && e.target.dataset.awemeId){
        const vid = e.target.dataset.awemeId;
        const r = await fetch(`/api/view/${vid}`, {method:'POST'});
        if (r.ok){
          const {play_count} = await r.json();
          const el = document.getElementById(`views-${vid}`);
          if (el) el.textContent = `${play_count} views`;
        }
      }
    }, true);

    // CUSTOM CONTEXT MENU LOGIC
    const customMenu = document.getElementById('custom-menu');
    let currentTarget = null;
    document.addEventListener('contextmenu', e => {
      if (e.target.tagName === 'VIDEO') {
        e.preventDefault();
        currentTarget = e.target;
        showMenuAt(e.clientX, e.clientY, ['menu-save','menu-open']);
      }
      else if (e.target.tagName === 'IMG' && e.target.classList.contains('single-img')) {
        e.preventDefault();
        currentTarget = e.target;
        showMenuAt(e.clientX, e.clientY, ['menu-download-image']);
      }
      else if (e.target.tagName === 'IMG' && e.target.closest('#image-modal')) {
        e.preventDefault();
        currentTarget = e.target;
        showMenuAt(e.clientX, e.clientY, ['menu-download-image']);
      }
      else {
        customMenu.style.display = 'none';
      }
    });
    function showMenuAt(x,y,showIds){
      customMenu.querySelectorAll('li').forEach(li=>{
        li.style.display = showIds.includes(li.id)?'block':'none';
        li.classList.toggle('glow', showIds.includes(li.id));
      });
      customMenu.style.top = y+'px';
      customMenu.style.left = x+'px';
      customMenu.style.display = 'block';
    }
    window.addEventListener('click', () => customMenu.style.display = 'none');

    document.getElementById('menu-save').onclick = () => {
      customMenu.style.display = 'none';
      const src = currentTarget.querySelector('source') ? currentTarget.querySelector('source').src : currentTarget.src;
      const a = document.createElement('a');
      a.href = src;
      a.download = '';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };
    document.getElementById('menu-open').onclick = () => {
      customMenu.style.display = 'none';
      const src = currentTarget.querySelector('source') ? currentTarget.querySelector('source').src : currentTarget.src;
      window.open(src, '_blank');
    };
    document.getElementById('menu-download-image').onclick = async () => {
      customMenu.style.display = 'none';
      const src = currentTarget.src;
      // Try blob download first
      const suggested = (currentTarget.dataset && currentTarget.dataset.awemeId) ? `${currentTarget.dataset.awemeId}.jpg` : '';
      const ok = await downloadUrlAsFile(src, suggested);
      if (!ok) fallbackDirectDownload(src, suggested);
    };

    // Image slideshow (modal + api open)
    (function(){
      const imgModal = document.getElementById('image-modal');
      const modalImg = imgModal.querySelector('img');
      const closeBtn = imgModal.querySelector('.close');
      const prevBtn  = imgModal.querySelector('.prev');
      const nextBtn  = imgModal.querySelector('.next');
      const downloadBtn = document.getElementById('modal-download');
      const downloadAllBtn = document.getElementById('modal-download-all');
      let currentImages = [];
      let currentIndex = 0;

      function showModal(){
        if (!currentImages || !currentImages.length) return;
        imgModal.style.display = 'flex';
        modalImg.src = currentImages[currentIndex];
      }
      function closeModal(){
        imgModal.style.display = 'none';
      }
      function showPrev(){
        if (!currentImages.length) return;
        currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
        showModal();
      }
      function showNext(){
        if (!currentImages.length) return;
        currentIndex = (currentIndex + 1) % currentImages.length;
        showModal();
      }

      // bind click on .single-img elements to open modal
      function bindSingleImages(){
        document.querySelectorAll('.single-img').forEach(img => {
          img.onclick = () => {
            const arr = JSON.parse(img.dataset.images || '[]');
            if (!arr.length) return;
            currentImages = arr;
            currentIndex = 0;
            // store metadata for suggested filenames
            imgModal.dataset.username = img.dataset.username || '';
            imgModal.dataset.aweme = img.dataset.awemeId || '';
            showModal();
          };
        });
      }
      bindSingleImages();

      // expose openSlideshow(images, index, metadata)
      window.openSlideshow = function(images, index, metadata){
        try {
          if (!Array.isArray(images) || !images.length) return;
          currentImages = images;
          currentIndex = (typeof index === 'number' && index >= 0) ? (index % images.length) : 0;
          // optional metadata
          imgModal.dataset.username = (metadata && metadata.username) || imgModal.dataset.username || '';
          imgModal.dataset.aweme = (metadata && metadata.aweme) || imgModal.dataset.aweme || '';
          showModal();
        } catch (e) {
          console.debug('openSlideshow error', e);
        }
      };

      closeBtn.onclick = closeModal;
      prevBtn.onclick  = showPrev;
      nextBtn.onclick  = showNext;

      downloadBtn.onclick = async () => {
        const src = modalImg.src;
        if (!src) { alert('No image to download'); return; }
        const username = imgModal.dataset.username || '';
        const aweme = imgModal.dataset.aweme || '';
        // build suggested filename
        const ext = (src.split('.').pop().split(/\#|\?/)[0] || 'jpg').substr(0,6);
        const suggested = `${username || aweme || 'image'}_${currentIndex + 1}.${ext}`;
        const ok = await downloadUrlAsFile(src, suggested);
        if (!ok) {
          fallbackDirectDownload(src, suggested);
        }
      };

      // download all: try zip via JSZip, fallback to individual downloads
      downloadAllBtn.onclick = async () => {
        const imgs = currentImages || [];
        if (!imgs.length) { alert('No images to download'); return; }
        const username = imgModal.dataset.username || '';
        const aweme = imgModal.dataset.aweme || '';
        await downloadAllImagesAsZip(imgs, `${username || aweme || 'slideshow'}_${Date.now()}`);
      };

      imgModal.onclick = e => {
        if (e.target === imgModal) closeModal();
      };

      window.addEventListener('slideshowRendered', bindSingleImages);
    })();

    // helper: download multiple images as ZIP (tries to fetch blobs, uses JSZip)
    async function downloadAllImagesAsZip(imageUrls, zipNameBase) {
      if (!imageUrls || !imageUrls.length) return;
      const zipName = `${zipNameBase || 'images'}_${(new Date()).toISOString().replace(/[:.]/g,'-')}.zip`;
      // If JSZip not available, fallback to sequential download
      if (typeof JSZip === 'undefined') {
        // fallback: attempt individual downloads
        for (let i = 0; i < imageUrls.length; i++) {
          const u = imageUrls[i];
          const ext = (u.split('.').pop().split(/\#|\?/)[0] || 'jpg').substr(0,6);
          const fname = `${zipNameBase || 'images'}_${i+1}.${ext}`;
          const ok = await downloadUrlAsFile(u, fname);
          if (!ok) fallbackDirectDownload(u, fname);
          // small delay to avoid overwhelming
          await new Promise(r => setTimeout(r, 200));
        }
        return;
      }

      try {
        const zip = new JSZip();
        let failures = [];
        for (let i = 0; i < imageUrls.length; i++) {
          const url = imageUrls[i];
          try {
            const res = await fetch(url, {mode: 'cors'});
            if (!res.ok) throw new Error('Fetch failed ' + res.status);
            const blob = await res.blob();
            // guess extension
            let ext = 'jpg';
            const ct = blob.type || '';
            if (ct && ct.includes('/')) ext = ct.split('/')[1].split(';')[0] || ext;
            const filename = `${zipNameBase || 'img'}_${i+1}.${ext}`;
            zip.file(filename, blob);
          } catch (err) {
            console.debug('Failed fetch image for zip', url, err);
            failures.push(url);
          }
        }

        if (zip && Object.keys(zip.files).length > 0) {
          const content = await zip.generateAsync({type:"blob"});
          // download the zip
          const blobUrl = URL.createObjectURL(content);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = zipName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
        }

        // If there were failures, attempt individual downloads for those
        if (failures.length) {
          alert(`${failures.length} image(s) couldn't be fetched due to CORS or network. Attempting direct downloads for those.`)
          for (let j = 0; j < failures.length; j++) {
            const u = failures[j];
            const ext = (u.split('.').pop().split(/\#|\?/)[0] || 'jpg').substr(0,6);
            const fname = `${zipNameBase || 'images'}_failed_${j+1}.${ext}`;
            const ok = await downloadUrlAsFile(u, fname);
            if (!ok) fallbackDirectDownload(u, fname);
            await new Promise(r => setTimeout(r, 200));
          }
        }

      } catch (e) {
        console.debug('downloadAllImagesAsZip error; falling back to individual downloads', e);
        // fallback to individual
        for (let i = 0; i < imageUrls.length; i++) {
          const u = imageUrls[i];
          const ext = (u.split('.').pop().split(/\#|\?/)[0] || 'jpg').substr(0,6);
          const fname = `${zipNameBase || 'images'}_${i+1}.${ext}`;
          const ok = await downloadUrlAsFile(u, fname);
          if (!ok) fallbackDirectDownload(u, fname);
          await new Promise(r => setTimeout(r, 200));
        }
      }
    }

    // Video placeholder -> create video element and lazy-load source
    document.body.addEventListener('click', async (e) => {
      const target = e.target.closest('.video-placeholder');
      if (!target) return;
      if (target.dataset.loading === '1') return;
      target.dataset.loading = '1';
      const playUrl = target.dataset.playUrl;
      const awemeId = target.dataset.awemeId;
      const video = document.createElement('video');
      video.controls = true;
      video.setAttribute('playsinline', '');
      video.dataset.awemeId = awemeId;
      const src = document.createElement('source');
      src.src = playUrl;
      src.type = 'video/mp4';
      video.appendChild(src);
      target.innerHTML = '';
      target.appendChild(video);
      try { await video.play(); } catch (err) {}
    });

    // Utility: grouping helper for slides (same as previous version) - kept for slideshow page
    function groupSlidesFromArray(arr){
      const map = new Map();
      function pushToMap(username, aweme_id, img, play_url, hd_url){
        if (!username) username = '';
        const key = `${username.toLowerCase()}|||${aweme_id||''}`;
        if (!map.has(key)){
          map.set(key, { username: username, aweme_id: aweme_id, images: [], play_url: play_url||'', hd_url: hd_url||'' });
        }
        const entry = map.get(key);
        if (play_url) entry.play_url = entry.play_url || play_url;
        if (hd_url) entry.hd_url = entry.hd_url || hd_url;
        if (img && !entry.images.includes(img)) entry.images.push(img);
      }

      for (const it of (arr||[])){
        try {
          if (Array.isArray(it.images) && it.images.length > 0) {
            const username = it.username || it.user || '';
            const aweme = it.aweme_id || it.aweme || it.id || '';
            const play = it.play_url || it.play || it.url || '';
            const hd = it.hd_url || it.hd || '';
            for (const im of it.images) pushToMap(username, aweme, im, play, hd);
            continue;
          }
          if (it.image_url || it.image) {
            const username = it.username || it.user || '';
            const aweme = it.aweme_id || it.aweme || it.id || '';
            const img = it.image_url || it.image || '';
            const play = it.play_url || it.play || '';
            const hd = it.hd_url || it.hd || '';
            if (img) pushToMap(username, aweme, img, play, hd);
            continue;
          }
          if (it.username && it.aweme_id && Array.isArray(it.images)) {
            for (const im of it.images || []) pushToMap(it.username, it.aweme_id, im, it.play_url, it.hd_url);
            continue;
          }
          const username = it.username || it.user || (it.data && it.data.username) || '';
          const aweme = it.aweme_id || it.aweme || (it.data && it.data.aweme_id) || '';
          const imgs = it.images || (it.data && it.data.images) || [];
          if (Array.isArray(imgs) && imgs.length){
            for (const im of imgs) pushToMap(username, aweme, im, it.play_url, it.hd_url);
            continue;
          }
          const play = it.play_url || it.play || (it.data && it.data.play_url) || '';
          if (play){
            pushToMap(username, aweme, '', play, it.hd_url || '');
          }
        } catch (e){
          console.debug('groupSlidesFromArray error', e, it);
        }
      }

      return Array.from(map.values()).map(v=>{
        if ((!v.images || !v.images.length) && v.play_url) {
          v.images = [v.play_url];
        }
        return v;
      });
    }

    // Slideshow functions (modified to remove HD from image cards and add download-all)
    async function fetchSlides(){
      try {
        const res = await fetch('/api/slideshow');
        if (res.ok) {
          const j = await res.json();
          let slides = groupSlidesFromArray(j);
          if (!slides.length) {
            slides = await trySavedUserUrlsFallback();
          }
          renderSlides(slides);
          window.dispatchEvent(new Event('slideshowRendered'));
          return;
        }
      } catch (e) {
        console.debug('fetch /api/slideshow failed', e);
      }
      const fallback = await trySavedUserUrlsFallback();
      renderSlides(fallback);
      window.dispatchEvent(new Event('slideshowRendered'));
    }

    async function trySavedUserUrlsFallback(){
      try {
        const r = await fetch('/api/saved-user-urls');
        if (r.ok) {
          const all = await r.json();
          return groupSlidesFromArray(all);
        }
      } catch (e){ console.debug('saved-user-urls fallback error', e); }
      try {
        const r2 = await fetch('/api/saved-urls');
        if (r2.ok) {
          const all2 = await r2.json();
          return groupSlidesFromArray(all2);
        }
      } catch (e) { console.debug('saved-urls fallback error', e); }
      return [];
    }

    function renderSlides(entries){
      const grid = document.getElementById('slideshow-grid');
      grid.innerHTML = '';
      if (!entries || !entries.length) {
        grid.innerHTML = '<p style="color:#aaa; text-align:center;">No slideshows found.</p>';
        return;
      }
      entries.forEach(v => {
        const card = document.createElement('div');
        card.className = 'card';
        const thumbUrl = (v.images && v.images.length && v.images[0]) ? v.images[0] : (v.play_url || 'https://raw.githubusercontent.com/itsjustragic/854847/main/static/bop.png');
        const img = document.createElement('img');
        img.src = thumbUrl;
        img.className = 'single-img';
        img.alt = `${v.username} ${v.aweme_id}`;
        img.dataset.images = JSON.stringify(v.images || []);
        img.dataset.awemeId = v.aweme_id || '';
        img.dataset.username = v.username || '';
        card.appendChild(img);
        const info = document.createElement('div');
        info.className = 'title';
        info.textContent = `${v.username} • ${v.aweme_id}`;
        card.appendChild(info);
        const btns = document.createElement('div');
        btns.className = 'card-buttons';

        // Download (single) — for image slideshows point to first image and force download
        const dlAnchor = document.createElement('a');
        if (v.images && v.images.length) {
          dlAnchor.href = v.images[0];
          dlAnchor.setAttribute('download','');
        } else if (v.play_url) {
          dlAnchor.href = v.play_url;
          dlAnchor.setAttribute('download','');
        } else {
          dlAnchor.href = '#';
        }
        const dlBtn = document.createElement('button');
        dlBtn.textContent = 'Download';
        dlAnchor.appendChild(dlBtn);
        btns.appendChild(dlAnchor);

        // Download All (card-level) - zips all images
        const dlAllBtn = document.createElement('button');
        dlAllBtn.textContent = 'Download All';
        dlAllBtn.onclick = async () => {
          const imgs = v.images || (v.play_url ? [v.play_url] : []);
          if (!imgs.length) { alert('No images to download'); return; }
          await downloadAllImagesAsZip(imgs, `${(v.username||'slideshow')}_${v.aweme_id || Date.now()}`);
        };
        btns.appendChild(dlAllBtn);

        // View button (opens modal)
        const viewBtn = document.createElement('button');
        viewBtn.textContent = 'View';
        viewBtn.onclick = () => {
          const imgsArr = JSON.parse(img.dataset.images || '[]');
          if (!imgsArr || !imgsArr.length) {
            alert('No images in this slideshow');
            return;
          }
          if (window.openSlideshow) {
            window.openSlideshow(imgsArr, 0, { username: img.dataset.username || '', aweme: img.dataset.awemeId || '' });
          } else {
            img.click();
          }
        };
        btns.appendChild(viewBtn);

        // NOTE: Removed HD button for image slideshow cards on purpose per request
        card.appendChild(btns);
        grid.appendChild(card);
      });
    }

    document.getElementById('slideshow-search-form').onsubmit = e=>e.preventDefault();
    document.querySelector('#slideshow-search-form button').onclick = () => {
      const input = document.getElementById('slideshow-search').value.trim();
      const params = new URLSearchParams(location.search);
      if (input) params.set('q', input);
      else params.delete('q');
      params.set('view','slideshow');
      window.history.replaceState({},'', `${location.pathname}?${params}`);
      fetchSlides();
    };

    // fetch saved-user-urls and saved-urls when refresh button clicked
    document.getElementById('btn-refresh').onclick = async () => {
      await fetchSavedUrls();
      await saveFetchedUserUrls(); // batched save
      alert('Refreshed saved URLs / saved user-urls.');
    };

    // toggle between images-only (stories) and show-all (include videos)
    const btnImagesOnly = document.getElementById('btn-images-only');
    const btnShowAll = document.getElementById('btn-show-all');
    const videosControls = document.getElementById('videos-controls');

    function setImagesOnlyMode(on) {
      btnImagesOnly.classList.toggle('active', on);
      btnShowAll.classList.toggle('active', !on);
      document.querySelectorAll('#videos-grid .card').forEach(card => {
        const hasImg = !!card.querySelector('.single-img');
        if (on) {
          card.style.display = hasImg ? '' : 'none';
        } else {
          card.style.display = '';
        }
      });
    }

    btnImagesOnly.onclick = () => setImagesOnlyMode(true);
    btnShowAll.onclick = () => setImagesOnlyMode(false);

    // -------- HD handling logic (ONLY uses submit task via /api/from-url; no fallback) --------
    function startProxyDownload(aweme) {
      try {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = `/download?video_id=${encodeURIComponent(aweme)}&hd=1`;
        document.body.appendChild(iframe);
        setTimeout(() => {
          try { document.body.removeChild(iframe); } catch (e) {}
        }, 60 * 1000);
      } catch (e) {
        console.debug('startProxyDownload error', e);
        window.open(`/download?video_id=${encodeURIComponent(aweme)}&hd=1`, '_blank');
      }
    }

    async function handleHdAction(button) {
      if (!button || button.disabled) return;
      const aweme = button.dataset.aweme;
      if (!aweme) {
        alert('Missing aweme id');
        return;
      }
      if (button.dataset.hd) {
        button.disabled = true;
        const orig = button.textContent;
        button.textContent = 'Downloading HD — 1 moment';
        const spinner = document.createElement('span');
        spinner.className = 'hd-spinner';
        button.appendChild(spinner);
        try {
          startProxyDownload(aweme);
        } finally {
          button.removeChild(spinner);
          button.textContent = orig;
          button.disabled = false;
        }
        return;
      }

      button.disabled = true;
      const origText = button.textContent;
      button.textContent = 'Downloading HD — 1 moment';
      const spinner = document.createElement('span');
      spinner.className = 'hd-spinner';
      button.appendChild(spinner);

      const maxAttempts = 3;
      let attempt = 0;
      const tUrl = `https://www.tiktok.com/video/${encodeURIComponent(aweme)}`;

      while (attempt < maxAttempts) {
        attempt++;
        try {
          const res = await fetch('/api/from-url', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({url: tUrl})
          });

          if (!res.ok) {
            console.debug('from-url attempt', attempt, 'status', res.status);
          } else {
            const body = await res.json().catch(()=>({}));
            const hd = body.hd_url || body.play_url || '';
            if (hd) {
              button.dataset.hd = hd;
              startProxyDownload(aweme);
              button.removeChild(spinner);
              button.textContent = origText;
              button.disabled = false;
              return;
            } else {
              console.debug('from-url attempt', attempt, 'no hd returned yet');
            }
          }
        } catch (err) {
          console.debug('from-url attempt error', attempt, err);
        }

        if (attempt < maxAttempts) {
          await new Promise(res => setTimeout(res, 2000));
        }
      }

      button.removeChild(spinner);
      button.textContent = origText;
      button.disabled = false;
      alert('Failed to prepare HD after multiple attempts. Try again later.');
    }

    // Global delegation for HD triggers
    document.addEventListener('click', (e) => {
      const hdBtn = e.target.closest('.hd-trigger');
      if (hdBtn) {
        e.preventDefault();
        handleHdAction(hdBtn);
      }
    });

    // init
    async function initApp(){
      highlightNav();
      await fetchSavedUrls();
      await saveFetchedUserUrls(); // batched save at load
      await fetchSlides();

      // If we're on latest or top, hide the images-only control and default to videos (no stories)
      if (VIEW_TYPE === 'latest' || VIEW_TYPE === 'top') {
        videosControls.classList.add('hidden');
        setImagesOnlyMode(false);
      } else {
        videosControls.classList.remove('hidden');
        // default: images-only (stories) mode ON
        setImagesOnlyMode(true);
      }

      window.dispatchEvent(new Event('slideshowRendered'));
    }

    window.addEventListener('load', async ()=>{
      document.getElementById('loader').classList.add('fade-out');
      setTimeout(async ()=>{
        document.getElementById('loader').style.display='none';
        initAuth();
        const token = localStorage.getItem('tikify_token');
        if (token){
          document.getElementById('auth-container').style.display='none';
          document.getElementById('app-content').style.display='block';
          await initApp();
        } else {
          document.getElementById('app-content').style.display='none';
          document.getElementById('auth-container').style.display='flex';
        }
      },600);
    });
  </script>
</body>
</html>
